import React, { useEffect, useRef } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';
import polyline from '@mapbox/polyline';

const map_direction = {
  profile: 'mapbox/cycling',
  coordinates: [
    [-80.8453, 35.1953],
    [-80.8443, 35.1962],
    [-80.8435, 35.1971],
    [-80.8427, 35.1981],
    [-80.8419, 35.1991],
    [-80.8409, 35.2002],
    [-80.8399, 35.2012],
    [-80.8389, 35.2022],
    [-80.8379, 35.2032],
    [-80.8369, 35.2042],
    [-80.8359, 35.2052],
    [-80.8349, 35.2062],
    [-80.8339, 35.2072],
    [-80.8329, 35.2082],
    [-80.8319, 35.2092],
    /////////
    // [-80.8493, 35.1914],
    // [-80.8356, 35.2011],
    // [-80.8249, 35.2123],
    // [-80.8142, 35.2235],
    // [-80.8035, 35.2347],
    /////////
    // [-80.842582, 35.215655],
    // [-80.839182, 35.216601],
    // [-80.8352, 35.217521],
    // [-80.830582, 35.218749],
    // [-80.826085, 35.219999],
    // [-80.822, 35.220999],
    // [-80.81835, 35.221833],
    // [-80.814, 35.222666],
    // [-80.809713, 35.223333],
    // [-80.805421, 35.224033],
    // [-80.801, 35.224666],
    // [-80.796621, 35.225333],
    // [-80.792217, 35.226],
    // [-80.787, 35.226666],
    // [-80.781828, 35.227333],
    // [-80.776601, 35.228],
    // [-80.771, 35.228666],
    // [-80.765333, 35.229],
    // [-80.759601, 35.229249],
    // [-80.754, 35.229499],
    // [-80.74835, 35.229666],
    // [-80.74265, 35.229833],
    // [-80.736, 35.23],
    // [-80.729, 35.230166],
    // [-80.722, 35.230333],
    // [-80.715, 35.230499],
    // [-80.708, 35.230666],
    // [-80.701, 35.230833],
    // [-80.694, 35.231],
    // [-80.687, 35.231166],
    // [-80.68002, 35.231333],
    // [-80.67295, 35.231499],
    // [-80.66573, 35.231666],
    // [-80.6585, 35.231833],
    // [-80.651, 35.232],
    // [-80.64333, 35.232166],
    // [-80.6355, 35.232333],
    // [-80.628, 35.232499],
    // [-80.62, 35.232666],
    // [-80.612, 35.232833],
    // [-80.604, 35.233],
    // [-80.596, 35.233166],
    // [-80.588, 35.233333],
    // [-80.5801, 35.233499],
    // [-80.5722, 35.233666],
    // [-80.5643, 35.233833],
    // [-80.5565, 35.234],
    // [-80.5487, 35.234166],
    // [-80.5409, 35.234333],
    // [-80.5332, 35.234499],
    // [-80.5254, 35.234666],
    // [-80.5177, 35.234833],
    // [-80.5101, 35.235],
    // [-80.5024, 35.235166],
    // [-80.4947, 35.235333],
    // [-80.4871, 35.235499],
    // [-80.4794, 35.235666],
    // [-80.4717, 35.235833],
    // [-80.464, 35.236],
    // [-80.4564, 35.236166],
    // [-80.4487, 35.236333],
    // [-80.441, 35.236499],
    // [-80.4334, 35.236666],
    // [-80.4257, 35.236833],
    // [-80.4181, 35.237],
    // [-80.4105, 35.237166],
    // [-80.4029, 35.237333],
    // [-80.3953, 35.237499],
    // [-80.3877, 35.237666],
    // [-80.3801, 35.237833],
    // [-80.3725, 35.238],
    // [-80.3649, 35.238166],
    // [-80.3573, 35.238333],
    // [-80.3497, 35.238499],
    // [-80.3421, 35.238666],
    // [-80.3345, 35.238833],
    // [-80.3269, 35.239],
    // [-80.3193, 35.239166],
    // [-80.3117, 35.239333],
    // [-80.3041, 35.239499],
    // [-80.2965, 35.239666],
    // [-80.2889, 35.239833],
    // [-80.2813, 35.24],
    // [-80.2737, 35.240166],
    // [-80.2661, 35.240333],
    // [-80.2585, 35.240499],
    // [-80.2509, 35.240666],
    // [-80.2433, 35.240833],
    // [-80.2357, 35.241],
    // [-80.2281, 35.241166],
    // [-80.2205, 35.241333],
    // [-80.2129, 35.241499],
    // [-80.2053, 35.241666],
    // [-80.1977, 35.241833],
    // [-80.1901, 35.242],
    // [-80.1825, 35.242166],
    // [-80.1749, 35.242333],
    // [-80.1673, 35.242499],
    // [-80.1597, 35.242666],
    // [-80.1521, 35.242833],
    // [-80.1445, 35.243],
    // [-80.1369, 35.243166],
    // [-80.1293, 35.243333],
    // [-80.1217, 35.243499],
    // [-80.1141, 35.243666],
    // [-80.1065, 35.243833],
    // [-80.0989, 35.244],
    // [-80.0913, 35.244166],
    // [-80.0837, 35.244333],
    // [-80.0761, 35.244499],
    // [-80.0685, 35.244666],
    // [-80.0609, 35.244833],
    // [-80.0533, 35.245],
    // [-80.0457, 35.245166],
    // [-80.0381, 35.245333],
    // [-80.0305, 35.245499],
    // [-80.0229, 35.245666],
    // [-80.0153, 35.245833],
    // [-80.0077, 35.246],
    // [-80.0001, 35.246166],
  ],
};

function Mapbox() {
  const mapContainerRef = useRef(null);
  const mapRef = useRef(null);

  useEffect(() => {
    mapboxgl.accessToken = import.meta.env.VITE_MAPBOX_API_KEY;

    mapRef.current = new mapboxgl.Map({
      container: mapContainerRef.current,
      center: [-80.8431, 35.2272],
      zoom: 12,
    });

    mapRef.current.on('load', async () => {
      const formattedCoords = map_direction.coordinates
        .map((pair) => pair.join(','))
        .join(';');

      await getMatchRoute(
        mapRef.current,
        map_direction.profile,
        formattedCoords
      );
    });
  }, []);

  return (
    <div
      style={{ height: '75vh' }}
      ref={mapContainerRef}
      className="map-container"
    />
  );
}

async function getMatchRoute(map, profile, coordinates) {
  try {
    const res = await fetch(
      `https://api.mapbox.com/matching/v5/${profile}/${coordinates}.json?access_token=${
        import.meta.env.VITE_MAPBOX_API_KEY
      }`
    );
    if (!res.ok) throw new Error('MapBox HTTP Request Error', res.status);
    const data = await res.json();
    console.log('Match API Response:', data);
    if (data.code === 'NoMatch') {
      // WARNING: Create fail safe for no match
      console.log('No match found for coordinates');
      return;
    }
    const matchRoute = data.matchings[0].geometry;

    if (map.getSource('route')) {
      map.removeLayer('route');
      map.removeSource('route');
    }
    const geojson = polyline.toGeoJSON(matchRoute);

    map.addSource('route', {
      type: 'geojson',
      data: {
        type: 'Feature',
        properties: {},
        geometry: geojson,
      },
    });

    map.addLayer({
      id: 'route',
      type: 'line',
      source: 'route',
      layout: {
        'line-join': 'round',
        'line-cap': 'round',
      },
      paint: {
        'line-color': '#880808',
        'line-width': 2,
      },
    });
  } catch (err) {
    console.log('Error rendering route', err);
  }
}

export default function Dummy() {
  return (
    <main>
      <Mapbox />;
    </main>
  );
}
